<p id="notice"><%= notice %></p>

<div class="card">
  <h2 class="card-heading lg"><%= @lesson.name %> <small><%= link_to 'Student view', course_lesson_path(@course, @lesson, :student => "true") %></small></h2>
  <div class="card-body">
    <p><%=raw @lesson.description %></p>
  </div>
</div>

<div class="row">
	<div class="col-md-6">
		<div class="card">
			<h2 class="card-heading lg"><%=t :inactive %></h2>
			<div class="card-body">
				<p>Inactive resources in this lesson</p>
			</div>
		</div>	
		<div class="bs-component">
      <div id="inactive" class="list-group">
		    <% @avaliable_resources.each do |resource| %>
		    	<div id="<%= resource.id %>" class="list-group-item">
		        <%=link_to view_resource_path(@course, @lesson, resource) do %>
		        	<%= render partial: 'resource', object: resource %>
		        <% end %>
		       </div>
		    <% end %>
      </div>
    </div>

		<div id="drop-inactive" class="drop">Drop here</div>    
	</div>

	<div class="col-md-6">
		<div class="card">
			<h2 class="card-heading lg"><%=t :active %></h2>
			<div class="card-body">
				<p>Active resources in this lesson</p>
			</div>
		</div>
		<div class="bs-component">
      <div id="active" class="list-group">
		    <% @resources.each do |resource| %>
		    	<div id="<%= resource.id %>" class="list-group-item">
		        <%=link_to view_resource_path(@course, @lesson, resource) do %>
		        	<%= render partial: 'resource', object: resource %>
		        <% end %>
		      </div>
		    <% end %>
			</div>
		</div>
		<div id="drop-active" class="drop">Drop here</div>    
	</div>

</div>

<script>
// Full example
(function() {
  var id_active = 'active';
  var id_inactive = 'inactive';
  var list_active = document.querySelector('#' + id_active);
  var list_inactive = document.querySelector('#' + id_inactive);
  var cols_active = document.querySelectorAll('#' + id_active + ' .list-group-item');
  var cols_inactive = document.querySelectorAll('#' + id_inactive + ' .list-group-item');
  var drop_active = document.querySelector('#drop-active');
  var drop_inactive = document.querySelector('#drop-inactive');
  var dragSrcEl_ = null;
  var xmlhttp = new XMLHttpRequest();
  var url = null;

  this.handleDragStart = function(e) {
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);

    url = "/es/courses/<%= @course.id %>/lessons/<%= @lesson.id %>/";
    dragSrcEl_ = this;

    // this/e.target is the source node.
    this.addClassName('moving');
  };

  this.handleDragOver = function(e) {
    if (e.preventDefault) {
      e.preventDefault(); // Allows us to drop.
    }

    e.dataTransfer.dropEffect = 'move';

    return false;
  };

  this.handleDragEnter = function(e) {
    this.addClassName('over');
  };

  this.handleDragLeave = function(e) {
    // this/e.target is previous target element.
    this.removeClassName('over');
  };

  this.handleDrop = function(e) {
    // this/e.target is current target element.

    if (e.stopPropagation) {
      e.stopPropagation(); // stops the browser from redirecting.
    }

		if (dragSrcEl_ != this) {
    	if (this.id == "drop-active") {
	    	url += "use_resource/" + dragSrcEl_.id;
      	xmlhttp.open("GET",url);
      	xmlhttp.send();
      	list_active.appendChild(dragSrcEl_);
      	list_inactive.removeChild(dragSrcEl_);      	
    	} else if (this.id == "drop-inactive") {
      	url += "del_resource/" + dragSrcEl_.id;
      	xmlhttp.open("GET",url);
      	xmlhttp.send();
      	list_active.removeChild(dragSrcEl_);
				list_inactive.appendChild(dragSrcEl_);      	
    	}
    }

    return false;
  };

  this.handleDragEnd = function(e) {
    // this/e.target is the source node.
    [].forEach.call(cols_active, function (col) {
      col.removeClassName('over');
      col.removeClassName('moving');
    });

    [].forEach.call(cols_inactive, function (col) {
      col.removeClassName('over');
      col.removeClassName('moving');
    });    
  };

  xmlhttp.onreadystatechange=function() {
    if (xmlhttp.readyState==4 && xmlhttp.status==200) {
      console.log(xmlhttp.responseText);
      document.getElementById("notice").innerHTML="OK";
    } else {
      document.getElementById("notice").innerHTML="Error";
    }
  }

  drop_active.addEventListener('drop', this.handleDrop, false);
  drop_active.addEventListener('dragend', this.handleDragEnd, false);
  drop_active.addEventListener('dragover', this.handleDragOver, false);

  drop_inactive.addEventListener('drop', this.handleDrop, false);
  drop_inactive.addEventListener('dragend', this.handleDragEnd, false);
  drop_inactive.addEventListener('dragover', this.handleDragOver, false);


  [].forEach.call(cols_active, function (col) {
    col.setAttribute('draggable', 'true');  // Enable columns to be draggable.
    col.addEventListener('dragstart', this.handleDragStart, false);
    col.addEventListener('dragenter', this.handleDragEnter, false);
    col.addEventListener('dragover', this.handleDragOver, false);
    col.addEventListener('dragleave', this.handleDragLeave, false);
    col.addEventListener('drop', this.handleDrop, false);
    col.addEventListener('dragend', this.handleDragEnd, false);
  });

  [].forEach.call(cols_inactive, function (col) {
    col.setAttribute('draggable', 'true');  // Enable columns to be draggable.
    col.addEventListener('dragstart', this.handleDragStart, false);
    col.addEventListener('dragenter', this.handleDragEnter, false);
    col.addEventListener('dragover', this.handleDragOver, false);
    col.addEventListener('dragleave', this.handleDragLeave, false);
    col.addEventListener('drop', this.handleDrop, false);
    col.addEventListener('dragend', this.handleDragEnd, false);
  });  
})();
</script>

<%= link_to 'Back', course_lessons_path(@course), :class => 'btn btn-default' %>
<%= link_to 'New resource', new_resource_path, :class => 'btn btn-success right' %>
